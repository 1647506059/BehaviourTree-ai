window.aiTree={},window.__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();var TaskStatus,Behavior=function(){function t(){this.status=TaskStatus.Invalid}return t.prototype.invalidate=function(){this.status=TaskStatus.Invalid},t.prototype.onStart=function(){},t.prototype.onEnd=function(){},t.prototype.tick=function(t){return this.status==TaskStatus.Invalid&&this.onStart(),this.status=this.update(t),this.status!=TaskStatus.Running&&this.onEnd(),this.status},t}(),BehaviorTree=function(){function t(t,e,n){void 0===n&&(n=.2),this.stepUpdateCounter=0,this._context=t,this._root=e,this.updatePeriod=this._elapsedTime=n}return t.prototype.tick=function(){this.stepUpdateCounter+=es.Time.deltaTime,this.updatePeriod>0?this.stepUpdateCounter>=this.updatePeriod&&(this._root.tick(this._context),this.stepUpdateCounter-=this.updatePeriod):this._root.tick(this._context)},t}(),BehaviorTreeBuilder=function(){function t(t){this._parentNodeStack=new Array,this._context=t}return t.begin=function(e){return new t(e)},t.prototype.setChildOnParent=function(t){var e=ArrayExt.peek(this._parentNodeStack);return e instanceof Composite?e.addChild(t):e instanceof Decorator&&(e.child=t,this.endDecorator()),this},t.prototype.pushParentNode=function(t){return this._parentNodeStack.length>0&&this.setChildOnParent(t),ArrayExt.push(this._parentNodeStack,t),this},t.prototype.endDecorator=function(){return this._currentNode=ArrayExt.pop(this._parentNodeStack),this},t.prototype.action=function(t){return Assert.isFalse(0==this._parentNodeStack.length,"无法创建无嵌套的动作节点, 它必须是一个叶节点"),this.setChildOnParent(new ExecuteAction(t))},t.prototype.actionR=function(t){return this.action(function(e){return t(e)?TaskStatus.Success:TaskStatus.Failure})},t.prototype.conditional=function(t){return Assert.isFalse(0==this._parentNodeStack.length,"无法创建无嵌套的条件节点, 它必须是一个叶节点"),this.setChildOnParent(new ExecuteActionConditional(t))},t.prototype.conditionalR=function(t){return this.conditional(function(e){return t(e)?TaskStatus.Success:TaskStatus.Failure})},t.prototype.logAction=function(t){return Assert.isFalse(0==this._parentNodeStack.length,"无法创建无嵌套的动作节点, 它必须是一个叶节点"),this.setChildOnParent(new LogAction(t))},t.prototype.waitAction=function(t){return Assert.isFalse(0==this._parentNodeStack.length,"无法创建无嵌套的动作节点, 它必须是一个叶节点"),this.setChildOnParent(new WaitAciton(t))},t.prototype.subTree=function(t){return Assert.isFalse(0==this._parentNodeStack.length,"无法创建无嵌套的动作节点, 它必须是一个叶节点"),this.setChildOnParent(new BehaviorTreeReference(t))},t.prototype.conditionalDecorator=function(t,e){void 0===e&&(e=!0);var n=new ExecuteActionConditional(t);return this.pushParentNode(new ConditionalDecorator(n,e))},t.prototype.conditionalDecoratorR=function(t,e){return void 0===e&&(e=!0),this.conditionalDecorator(function(e){return t(e)?TaskStatus.Success:TaskStatus.Failure},e)},t.prototype.alwaysFail=function(){return this.pushParentNode(new AlwaysFail)},t.prototype.alwaysSucceed=function(){return this.pushParentNode(new AlwaysSucceed)},t.prototype.inverter=function(){return this.pushParentNode(new Inverter)},t.prototype.repeater=function(t){return this.pushParentNode(new Repeater(t))},t.prototype.untilFail=function(){return this.pushParentNode(new UntilFail)},t.prototype.untilSuccess=function(){return this.pushParentNode(new UntilSuccess)},t.prototype.paraller=function(){return this.pushParentNode(new Parallel)},t.prototype.parallelSelector=function(){return this.pushParentNode(new ParallelSelector)},t.prototype.selector=function(t){return void 0===t&&(t=AbortTypes.None),this.pushParentNode(new Selector(t))},t.prototype.randomSelector=function(){return this.pushParentNode(new RandomSelector)},t.prototype.sequence=function(t){return void 0===t&&(t=AbortTypes.None),this.pushParentNode(new Sequence(t))},t.prototype.randomSequence=function(){return this.pushParentNode(new RandomSequence)},t.prototype.endComposite=function(){return Assert.isTrue(ArrayExt.peek(this._parentNodeStack)instanceof Composite,"尝试结束复合器，但顶部节点是装饰器"),this._currentNode=ArrayExt.pop(this._parentNodeStack),this},t.prototype.build=function(t){return void 0===t&&(t=.2),Assert.isNotNull(this._currentNode,"无法创建零节点的行为树"),new BehaviorTree(this._context,this._currentNode,t)},t}();!function(t){t[t.Invalid=0]="Invalid",t[t.Success=1]="Success",t[t.Failure=2]="Failure",t[t.Running=3]="Running"}(TaskStatus||(TaskStatus={}));var AbortTypes,BehaviorTreeReference=function(t){function e(e){var n=t.call(this)||this;return n._childTree=e,n}return __extends(e,t),e.prototype.update=function(t){return this._childTree.tick(),TaskStatus.Success},e}(Behavior),ExecuteAction=function(t){function e(e){var n=t.call(this)||this;return n._action=e,n}return __extends(e,t),e.prototype.update=function(t){return Assert.isNotNull(this._action,"action 必须不为空"),this._action(t)},e}(Behavior),LogAction=function(t){function e(e){var n=t.call(this)||this;return n.text=e,n}return __extends(e,t),e.prototype.update=function(t){return this.isError?console.error(this.text):console.log(this.text),TaskStatus.Success},e}(Behavior),WaitAciton=function(t){function e(e){var n=t.call(this)||this;return n.waitTime=e,n}return __extends(e,t),e.prototype.onStart=function(){this._startTime=0},e.prototype.update=function(t){return 0==this._startTime&&(this._startTime=es.Time.totalTime),es.Time.totalTime-this._startTime>=this.waitTime?TaskStatus.Success:TaskStatus.Running},e}(Behavior);!function(t){t[t.None=0]="None",t[t.LowerPriority=1]="LowerPriority",t[t.Self=2]="Self",t[t.Both=3]="Both"}(AbortTypes||(AbortTypes={}));var fsm,AbortTypesExt=function(){function t(){}return t.has=function(t,e){return(t&e)==e},t}(),Composite=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.abortType=AbortTypes.None,e._children=new Array,e._currentChildIndex=0,e}return __extends(e,t),e.prototype.invalidate=function(){t.prototype.invalidate.call(this);for(var e=0;e<this._children.length;e++)this._children[e].invalidate()},e.prototype.onStart=function(){this._hasLowerPriorityConditionalAbort=this.hasLowerPriorityConditionalAbortInChildren(),this._currentChildIndex=0},e.prototype.onEnd=function(){for(var t=0;t<this._children.length;t++)this._children[t].invalidate()},e.prototype.hasLowerPriorityConditionalAbortInChildren=function(){for(var t=0;t<this._children.length;t++){var e=this._children[t];if(null!=e&&AbortTypesExt.has(e.abortType,AbortTypes.LowerPriority)&&e.isFirstChildConditional())return!0}return!1},e.prototype.addChild=function(t){this._children.push(t)},e.prototype.isFirstChildConditional=function(){return isIConditional(this._children[0])},e.prototype.updateSelfAbortConditional=function(t,e){for(var n=0;n<this._currentChildIndex;n++){var i=this._children[n];if(isIConditional(i))if(this.updateConditionalNode(t,i)!=e){this._currentChildIndex=n;for(var r=n;r<this._children.length;r++)this._children[r].invalidate();break}}},e.prototype.updateLowerPriorityAbortConditional=function(t,e){for(var n=0;n<this._currentChildIndex;n++){var i=this._children[n];if(null!=i&&AbortTypesExt.has(i.abortType,AbortTypes.LowerPriority)){var r=i._children[0];if(this.updateConditionalNode(t,r)!=e){this._currentChildIndex=n;for(var o=n;o<this._children.length;o++)this._children[o].invalidate();break}}}},e.prototype.updateConditionalNode=function(t,e){return e instanceof ConditionalDecorator?e.executeConditional(t,!0):e.update(t)},e}(Behavior),Parallel=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.update=function(t){for(var e=!0,n=0;n<this._children.length;n++){var i=this._children[n];if(i.tick(t),i.status==TaskStatus.Failure)return TaskStatus.Failure;i.status!=TaskStatus.Success&&(e=!1)}return e?TaskStatus.Success:TaskStatus.Running},e}(Composite),ParallelSelector=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.update=function(t){for(var e=!0,n=0;n<this._children.length;n++){var i=this._children[n];if(i.tick(t),i.status==TaskStatus.Success)return TaskStatus.Success;i.status!=TaskStatus.Failure&&(e=!1)}return e?TaskStatus.Failure:TaskStatus.Running},e}(Composite),Selector=function(t){function e(e){void 0===e&&(e=AbortTypes.None);var n=t.call(this)||this;return n.abortType=e,n}return __extends(e,t),e.prototype.update=function(t){0!=this._currentChildIndex&&this.handleConditionalAborts(t);var e=this._children[this._currentChildIndex].tick(t);return e!=TaskStatus.Failure?e:(this._currentChildIndex++,this._currentChildIndex==this._children.length?(this._currentChildIndex=0,TaskStatus.Failure):TaskStatus.Running)},e.prototype.handleConditionalAborts=function(t){this._hasLowerPriorityConditionalAbort&&this.updateLowerPriorityAbortConditional(t,TaskStatus.Failure),AbortTypesExt.has(this.abortType,AbortTypes.Self)&&this.updateSelfAbortConditional(t,TaskStatus.Failure)},e}(Composite),RandomSelector=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onStart=function(){ArrayExt.shuffle(this._children)},e}(Selector),Sequence=function(t){function e(e){void 0===e&&(e=AbortTypes.None);var n=t.call(this)||this;return n.abortType=e,n}return __extends(e,t),e.prototype.update=function(t){0!=this._currentChildIndex&&this.handleConditionalAborts(t);var e=this._children[this._currentChildIndex].tick(t);return e!=TaskStatus.Success?e:(this._currentChildIndex++,this._currentChildIndex==this._children.length?(this._currentChildIndex=0,TaskStatus.Success):TaskStatus.Running)},e.prototype.handleConditionalAborts=function(t){this._hasLowerPriorityConditionalAbort&&this.updateLowerPriorityAbortConditional(t,TaskStatus.Success),AbortTypesExt.has(this.abortType,AbortTypes.Self)&&this.updateSelfAbortConditional(t,TaskStatus.Success)},e}(Composite),RandomSequence=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onStart=function(){ArrayExt.shuffle(this._children)},e}(Sequence),ExecuteActionConditional=function(t){function e(e){return t.call(this,e)||this}return __extends(e,t),e}(ExecuteAction),isIConditional=function(t){return void 0!==t.update},RandomProbability=function(t){function e(e){var n=t.call(this)||this;return n._successProbability=e,n}return __extends(e,t),e.prototype.update=function(t){return Math.random()>this._successProbability?TaskStatus.Success:TaskStatus.Failure},e}(Behavior),Decorator=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.invalidate=function(){t.prototype.invalidate.call(this),this.child.invalidate()},e}(Behavior),AlwaysFail=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.update=function(t){return Assert.isNotNull(this.child,"child必须不能为空"),this.child.update(t)==TaskStatus.Running?TaskStatus.Running:TaskStatus.Failure},e}(Decorator),AlwaysSucceed=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.update=function(t){return Assert.isNotNull(this.child,"child必须不能为空"),this.child.update(t)==TaskStatus.Running?TaskStatus.Running:TaskStatus.Success},e}(Decorator),ConditionalDecorator=function(t){function e(e,n){void 0===n&&(n=!0);var i=t.call(this)||this;return Assert.isTrue(isIConditional(e),"conditional 必须继承 IConditional"),i._conditional=e,i._shouldReevaluate=n,i}return __extends(e,t),e.prototype.invalidate=function(){t.prototype.invalidate.call(this),this._conditionalStatus=TaskStatus.Invalid},e.prototype.onStart=function(){this._conditionalStatus=TaskStatus.Invalid},e.prototype.update=function(t){return Assert.isNotNull(this.child,"child不能为空"),this._conditionalStatus=this.executeConditional(t),this._conditionalStatus==TaskStatus.Success?this.child.tick(t):TaskStatus.Failure},e.prototype.executeConditional=function(t,e){return void 0===e&&(e=!1),(e||this._shouldReevaluate||this._conditionalStatus==TaskStatus.Invalid)&&(this._conditionalStatus=this._conditional.update(t)),this._conditionalStatus},e}(Decorator),Inverter=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.update=function(t){Assert.isNotNull(this.child,"child必须不能为空");var e=this.child.tick(t);return e==TaskStatus.Success?TaskStatus.Failure:e==TaskStatus.Failure?TaskStatus.Success:TaskStatus.Running},e}(Decorator),Repeater=function(t){function e(e,n){void 0===n&&(n=!1);var i=t.call(this)||this;return i.count=e,i.endOnFailure=n,i}return __extends(e,t),e.prototype.onStart=function(){this._iterationCount=0},e.prototype.update=function(t){if(Assert.isNotNull(this.child,"child必须不能为空"),!this.repeatForever&&this._iterationCount==this.count)return TaskStatus.Success;var e=this.child.tick(t);return this._iterationCount++,this.endOnFailure&&e==TaskStatus.Failure?TaskStatus.Success:this.repeatForever||this._iterationCount!=this.count?TaskStatus.Running:TaskStatus.Success},e}(Decorator),UntilFail=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.update=function(t){return Assert.isNotNull(this.child,"child必须不为空"),this.child.update(t)!=TaskStatus.Failure?TaskStatus.Running:TaskStatus.Success},e}(Decorator),UntilSuccess=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.update=function(t){return Assert.isNotNull(this.child,"child必须不为空"),this.child.update(t)!=TaskStatus.Success?TaskStatus.Running:TaskStatus.Success},e}(Decorator),ArrayExt=function(){function t(){}return t.shuffle=function(t){for(var e=t.length-1;e>1;){e--;var n=Random.range(0,e+1),i=t[n];t[n]=t[e],t[e]=i}},t.peek=function(t){return t[0]},t.push=function(t,e){t.splice(0,0,e)},t.pop=function(t){return t.shift()},t}(),Assert=function(){function t(){}return t.fail=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];t?console.assert(!1,t,e):console.assert(!1)},t.isTrue=function(e,n){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];e||(n?t.fail(n,i):t.fail())},t.isNotNull=function(e,n){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];t.isTrue(null!=e,n,i)},t.isFalse=function(t,e){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];e?this.isTrue(!t,e,n):this.isTrue(!t)},t}(),Mathf=function(){function t(){}return t.map01=function(t,e,n){return 1*(t-e)/(n-e)},t}(),Random=function(){function t(){}return t.range=function(t,e){var n=(new Date).getTime();return(t=t||0)+(n=(9301*n+49297)%233280)/233280*((e=e||1)-t)},t}(),TimerItem=function(){function t(){this.delay=0,this.repeat=0,this.counter=0}return t.prototype.advance=function(t){return void 0===t&&(t=0),this.counter+=t,this.counter>=this.delay&&(this.counter-=this.delay,this.counter>this.delay&&(this.counter=this.delay),this.repeat>0&&(this.repeat--,0==this.repeat&&(this.end=!0)),!0)},t.prototype.reset=function(){this.callback=null,this.thisObj=null,this.param=null},t}();!function(t){var e=function(){function t(){}return t.prototype.setMachineAndContext=function(t,e){this._machine=t,this._context=e,this.onInitialized()},t.prototype.onInitialized=function(){},t.prototype.begin=function(){},t.prototype.reason=function(){},t.prototype.end=function(){},t}();t.State=e}(fsm||(fsm={})),function(t){var e=function(){function t(t,e,n){this.elapsedTimeInState=0,this._states=new Map,this._context=t,this.addState(e,n),this._currentState=n,this._currentState.begin()}return Object.defineProperty(t.prototype,"currentState",{get:function(){return this._currentState},enumerable:!0,configurable:!0}),t.prototype.addState=function(t,e){e.setMachineAndContext(this,this._context),this._states.set(t,e)},t.prototype.update=function(t){this.elapsedTimeInState+=t,this._currentState.reason(),this._currentState.update(t)},t.prototype.getState=function(t){return this._states.has(t)?this._states.get(t):(console.error("状态"+t+"不存在。你是不是在调用addState的时候忘记添加了?"),null)},t.prototype.changeState=function(t){return this._currentState instanceof t?this._currentState:(this.currentState&&this._currentState.end(),this._states.has(t)?(this.elapsedTimeInState=0,this.previousState=this._currentState,this._currentState=this._states.get(t),this._currentState.begin(),this.onStateChanged&&this.onStateChanged(),this._currentState):void console.error("状态"+t+"不存在。你是不是在调用addState的时候忘记添加了?"))},t}();t.StateMachine=e}(fsm||(fsm={}));var utility,UtilityAI=function(){function t(t,e,n){void 0===n&&(n=.2),this._rootReasoner=e,this._context=t,this.updatePeriod=this._elapsedTime=n}return t.prototype.tick=function(){for(this._elapsedTime-=es.Time.deltaTime;this._elapsedTime<=0;){this._elapsedTime+=this.updatePeriod;var t=this._rootReasoner.select(this._context);null!=t&&t.execute(this._context)}},t}(),ActionExecutor=function(){function t(t){this._action=t}return t.prototype.execute=function(t){this._action(t)},t}(),ActionWithOptions=function(){function t(){this._appraisals=new Array}return t.prototype.getBestOption=function(t,e){for(var n,i=-3.402823e38,r=0;r<e.length;r++){for(var o=e[r],s=0,a=0;a<this._appraisals.length;a++)s+=this._appraisals[a].getScore(t,o);s>i&&(i=s,n=o)}return n},t.prototype.addScorer=function(t){return this._appraisals.push(t),this},t}(),CompositeAction=function(){function t(){this._actions=new Array}return t.prototype.execute=function(t){for(var e=0;e<this._actions.length;e++)this._actions[e].execute(t)},t.prototype.addAction=function(t){return this._actions.push(t),this},t}();utility||(utility={}),function(){function t(t){this._text=t}t.prototype.execute=function(t){console.log(this._text)}}();var ReasonerAction=function(){function t(t){this._reasoner=t}return t.prototype.execute=function(t){var e=this._reasoner.select(t);null!=e&&e.execute(t)},t}(),AllOrNothingConsideration=function(){function t(t){void 0===t&&(t=0),this._appraisals=new Array,this.threshold=t}return t.prototype.addAppraisal=function(t){return this._appraisals.push(t),this},t.prototype.getScore=function(t){for(var e=0,n=0;n<this._appraisals.length;n++){var i=this._appraisals[n].getScore(t);if(i<this.threshold)return 0;e+=i}return e},t}(),FixedScoreConsideration=function(){function t(t){void 0===t&&(t=1),this.score=t}return t.prototype.getScore=function(t){return this.score},t}(),SumOfChildrenConsideration=function(){function t(){this._appraisals=new Array}return t.prototype.getScore=function(t){for(var e=0,n=0;n<this._appraisals.length;n++)e+=this._appraisals[n].getScore(t);return e},t}(),ThresholdConsideration=function(){function t(t){this._appraisals=new Array,this.threshold=t}return t.prototype.getScore=function(t){for(var e=0,n=0;n<this._appraisals.length;n++){var i=this._appraisals[n].getScore(t);if(i<this.threshold)return e;e+=i}return e},t}(),ActionAppraisal=function(){function t(t){this._appraisalAction=t}return t.prototype.getScore=function(t){return this._appraisalAction(t)},t}(),Reasoner=function(){function t(){this.defaultConsideration=new FixedScoreConsideration,this._condiderations=new Array}return t.prototype.select=function(t){var e=this.selectBestConsideration(t);return null!=e?e.action:null},t.prototype.addConsideration=function(t){return this._condiderations.push(t),this},t.prototype.setDefaultConsideration=function(t){return this.defaultConsideration=t,this},t}(),FirstScoreReasoner=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.selectBestConsideration=function(t){for(var e=this.defaultConsideration.getScore(t),n=0;n<this._condiderations.length;n++)if(this._condiderations[n].getScore(t)>=e)return this._condiderations[n];return this.defaultConsideration},e}(Reasoner),HighestScoreReasoner=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.selectBestConsideration=function(t){for(var e=this.defaultConsideration.getScore(t),n=null,i=0;i<this._condiderations.length;i++){var r=this._condiderations[i].getScore(t);r>e&&(e=r,n=this._condiderations[i])}return null==n?this.defaultConsideration:n},e}(Reasoner);